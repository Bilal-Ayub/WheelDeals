{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - WheelDeals{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Welcome Admin!</h2>
        </div>
    </div>
    
    <!-- Statistics Cards Row -->
    <div class="row">
        <!-- Total Users -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Users</h6>
                    <h3 class="mb-0">{{ total_users }}</h3>
                </div>
            </div>
        </div>
        
        <!-- Total Buyers -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Buyers</h6>
                    <h3 class="mb-0">{{ total_buyers }}</h3>
                </div>
            </div>
        </div>
        
        <!-- Total Sellers -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Sellers</h6>
                    <h3 class="mb-0">{{ total_sellers }}</h3>
                </div>
            </div>
        </div>
        
        <!-- Total Users Online -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Users online</h6>
                    <h3 class="mb-0">{{ users_online }}</h3>
                </div>
            </div>
        </div>
        
        <!-- Total Ads -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Ads</h6>
                    <h3 class="mb-0">{{ total_ads }}</h3>
                </div>
            </div>
        </div>
        
        <!-- Approval Requests (Pending Ads) -->
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Approval requests</h6>
                    <h3 class="mb-0">{{ pending_ads }}</h3>
                    <a href="{% url 'admin_pending_ads' %}" class="btn btn-sm btn-warning mt-2">Review</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts and Pending Requests Row -->
    <div class="row mt-4">
        <!-- Ads Posted by City (Pie Chart) -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Ads Posted by City</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px; position: relative;">
                        <canvas id="cityChart"></canvas>
                    </div>
                    <ul class="list-unstyled mt-3 small">
                        {% for city in ads_by_city %}
                        <li class="mb-1">
                            <span class="badge bg-secondary">{{ city.count }}</span>
                            {{ city.seller__city|default:"Unknown" }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Ads by Make (Bar Chart) -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Ads by Make</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="makeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pending Requests -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Pending Requests</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for ad in pending_ads_list|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <div class="flex-grow-1">
                            {% if ad.image1 %}
                            <img src="{{ ad.image1.url }}" alt="{{ ad }}" class="rounded me-2" style="width: 40px; height: 30px; object-fit: cover;">
                            {% else %}
                            <div class="d-inline-block bg-secondary rounded me-2" style="width: 40px; height: 30px;"></div>
                            {% endif %}
                            <small><strong>{{ ad.year }} {{ ad.make }} {{ ad.model }}</strong><br>
                            <span class="text-muted">by {{ ad.seller.get_full_name|default:ad.seller.username }}</span></small>
                        </div>
                        <div>
                            <a href="{% url 'admin_pending_ads' %}" class="btn btn-warning btn-sm">Review</a>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No pending ads</p>
                    {% endfor %}
                    <a href="{% url 'admin_pending_ads' %}" class="btn btn-sm btn-outline-primary w-100 mt-2">View All Pending</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'admin_pending_ads' %}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-clock"></i> Pending Ads ({{ pending_ads }})
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'admin_user_management' %}" class="btn btn-outline-info w-100">
                                <i class="fas fa-users"></i> Manage Users
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'admin_inspection_oversight' %}" class="btn btn-outline-success w-100">
                                <i class="fas fa-clipboard-check"></i> Inspections
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{% url 'admin_all_listings' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-car"></i> All Listings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inspection Statistics -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Total Inspections</h6>
                    <h3>{{ total_inspections }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Completed Inspections</h6>
                    <h3>{{ completed_inspections }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">In Progress Inspections</h6>
                    <h3>{{ in_progress_inspections }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// City Pie Chart
const cityCtx = document.getElementById('cityChart').getContext('2d');
const cityChart = new Chart(cityCtx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for city in ads_by_city %}
            '{{ city.seller__city|default:"Unknown" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for city in ads_by_city %}
                {{ city.count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#36A2EB',
                '#FF6384',
                '#4BC0C0',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Make Bar Chart
const makeCtx = document.getElementById('makeChart').getContext('2d');
const makeChart = new Chart(makeCtx, {
    type: 'bar',
    data: {
        labels: [
            {% for make in ads_by_make %}
            '{{ make.make }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Number of Ads',
            data: [
                {% for make in ads_by_make %}
                {{ make.count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}
